<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Organizer</title>
    
    <!-- React and Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- MSAL.js for Microsoft Authentication -->
    <script src="https://alcdn.msauth.net/browser/2.32.2/js/msal-browser.min.js"></script>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #667eea;
            --primary-dark: #764ba2;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #3498db;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --white: #ffffff;
            --gray: #95a5a6;
            --border: #e0e6ed;
            
            /* Category Colors */
            --cat-home: #3498db;
            --cat-leisure: #9b59b6;
            --cat-gr-yaris: #f39c12;
            --cat-street-triple: #e74c3c;
            --cat-birthday: #e91e63;
            --cat-other: #bdc3c7;
            --cat-waste-general: #2c3e50;
            --cat-waste-paper: #2980b9;
            --cat-waste-glass: #27ae60;
            --cat-waste-pmc: #5dade2;
            --cat-task: #ff6b35;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        /* Sync Indicator */
        .sync-indicator {
            position: absolute;
            top: 20px;
            right: -10px;
            background: white;
            padding: 8px 20px 8px 15px;
            border-radius: 20px 0 0 20px;
            box-shadow: -5px 5px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 100;
        }
        
        .sync-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--gray);
            transition: all 0.3s ease;
        }
        
        .sync-dot.synced {
            background: var(--success);
            box-shadow: 0 0 10px rgba(46, 204, 113, 0.5);
        }
        
        .sync-dot.syncing {
            background: var(--warning);
            animation: pulse 1s infinite;
        }
        
        .sync-dot.error {
            background: var(--danger);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
        }
        
        /* Navigation */
        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: white;
            border-radius: 15px;
            padding: 5px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .nav-tab {
            flex: 1;
            padding: 15px 25px;
            text-align: center;
            border: none;
            background: transparent;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #7f8c8d;
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .fab:hover {
            transform: translateY(-3px) rotate(90deg);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.5);
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }
        
        .modal {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            padding: 25px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--dark);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s;
        }
        
        .modal-close:hover {
            color: var(--dark);
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }
        
        /* Date Picker Enhancement */
        .date-input-wrapper {
            position: relative;
        }
        
        .date-input-wrapper input {
            cursor: pointer;
            background: white url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%23667eea" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>') no-repeat right 15px center;
            padding-right: 45px;
        }
        
        /* Buttons */
        .btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: none;
            letter-spacing: 0.5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: var(--gray);
        }
        
        .btn-success {
            background: var(--success);
        }
        
        .btn-danger {
            background: var(--danger);
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-label {
            color: var(--gray);
            font-weight: 600;
            margin-top: 5px;
        }
        
        /* Task Cards */
        .task-section {
            margin-bottom: 30px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }
        
        .section-title {
            font-size: 1.3em;
            font-weight: 700;
            color: var(--dark);
        }
        
        .task-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            border-left: 4px solid var(--primary);
            transition: all 0.3s ease;
        }
        
        .task-card:hover {
            transform: translateX(5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }
        
        .task-card.completed {
            opacity: 0.7;
            border-left-color: var(--success);
        }
        
        .task-card.overdue {
            border-left-color: var(--danger);
        }
        
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .task-title {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--dark);
        }
        
        .task-badges {
            display: flex;
            gap: 8px;
        }
        
        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .priority-high { background: #ffebee; color: #c62828; }
        .priority-medium { background: #fff3e0; color: #ef6c00; }
        .priority-low { background: #e8f5e8; color: #2e7d32; }
        
        .task-meta {
            font-size: 14px;
            color: var(--gray);
            margin-top: 10px;
        }
        
        .task-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* Calendar */
        .calendar-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .calendar-nav {
            display: flex;
            gap: 10px;
        }
        
        .calendar-nav button {
            background: var(--primary);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18px;
        }
        
        .calendar-nav button:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }
        
        .calendar-title {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--dark);
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--border);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .calendar-day-header {
            background: var(--primary);
            color: white;
            padding: 15px 5px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
        }
        
        .calendar-day {
            background: white;
            min-height: 100px;
            padding: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }
        
        .calendar-day:hover {
            background: #f8f9fa;
        }
        
        .calendar-day.other-month {
            background: #f8f9fa;
            color: #bdc3c7;
        }
        
        .calendar-day.today {
            background: #e3f2fd;
        }
        
        .calendar-day-number {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .calendar-event {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            margin-bottom: 2px;
            cursor: pointer;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: white;
            font-weight: 500;
        }
        
        /* Calendar Event Colors */
        .event-home { background: var(--cat-home); }
        .event-leisure { background: var(--cat-leisure); }
        .event-gr-yaris { background: var(--cat-gr-yaris); }
        .event-street-triple { background: var(--cat-street-triple); }
        .event-birthday { background: var(--cat-birthday); }
        .event-other { background: var(--cat-other); }
        .event-poubelles-black { background: var(--cat-waste-general); }
        .event-poubelles-blue { background: var(--cat-waste-paper); }
        .event-poubelles-green { background: var(--cat-waste-glass); }
        .event-poubelles-blue-bag { background: var(--cat-waste-pmc); }
        .event-task { background: var(--cat-task); }
        
        /* Grocery Items */
        .grocery-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
            border-left: 4px solid var(--primary);
        }
        
        .grocery-item:hover {
            transform: translateX(5px);
        }
        
        .grocery-item.completed {
            opacity: 0.6;
            border-left-color: var(--success);
        }
        
        .grocery-item.completed .grocery-name {
            text-decoration: line-through;
        }
        
        .grocery-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .grocery-content {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .grocery-name {
            font-weight: 600;
            color: var(--dark);
        }
        
        /* Category Filters */
        .category-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .category-filter {
            padding: 8px 16px;
            border: 2px solid var(--border);
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .category-filter.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }
        
        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray);
        }
        
        .empty-state h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }
        
        /* Sign Out Button */
        .sign-out-wrapper {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }
        
        /* Conflict Resolution Modal */
        .conflict-preview {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .conflict-version {
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: #f8f9fa;
        }
        
        .conflict-version.selected {
            border-color: var(--primary);
            background: #e3f2fd;
        }
        
        .conflict-version h4 {
            margin-bottom: 10px;
            color: var(--dark);
        }
        
        .conflict-version pre {
            font-size: 12px;
            white-space: pre-wrap;
            color: var(--gray);
        }
        
        /* Loading State */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--gray);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .app-container {
                padding: 20px;
                border-radius: 15px;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .form-row, .form-row-3 {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .calendar-day {
                min-height: 80px;
                padding: 5px;
            }
            
            .calendar-event {
                font-size: 10px;
                padding: 1px 4px;
            }
            
            .fab {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            .modal {
                margin: 10px;
            }
            
            .conflict-preview {
                grid-template-columns: 1fr;
            }
        }
        
        /* Year View Calendar */
        .year-view {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        
        .month-mini {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .month-mini-header {
            text-align: center;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--dark);
        }
        
        .month-mini-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            font-size: 12px;
        }
        
        .month-mini-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
        }
        
        .month-mini-day.has-events::after {
            content: '';
            position: absolute;
            bottom: 2px;
            width: 4px;
            height: 4px;
            background: var(--primary);
            border-radius: 50%;
        }
        
        .month-mini-day.today {
            background: var(--primary);
            color: white;
            border-radius: 50%;
        }
        
        @media (max-width: 768px) {
            .year-view {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;
        
        // MSAL Configuration
        const msalConfig = {
            auth: {
                clientId: '427fd9fd-4cba-4121-9a5c-3f11318c2494',
                authority: 'https://login.microsoftonline.com/consumers',
                redirectUri: 'https://nauroth.github.io/personal-organizer/'
            }
        };
        
        // Initialize MSAL instance
        const msalInstance = new msal.PublicClientApplication(msalConfig);
        
        // OneDrive API Helper
        class OneDriveSync {
            constructor(accessToken) {
                this.accessToken = accessToken;
                this.baseUrl = 'https://graph.microsoft.com/v1.0/me/drive';
            }
            
            async ensureAppFolder() {
                try {
                    // Check if folder exists
                    const response = await fetch(`${this.baseUrl}/root:/PersonalOrganizer`, {
                        headers: { 'Authorization': `Bearer ${this.accessToken}` }
                    });
                    
                    if (!response.ok) {
                        // Create folder if it doesn't exist
                        await fetch(`${this.baseUrl}/root/children`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${this.accessToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                name: 'PersonalOrganizer',
                                folder: {},
                                '@microsoft.graph.conflictBehavior': 'rename'
                            })
                        });
                    }
                } catch (error) {
                    console.error('Error ensuring app folder:', error);
                }
            }
            
            async readFile(filename) {
                try {
                    const response = await fetch(`${this.baseUrl}/root:/PersonalOrganizer/${filename}:/content`, {
                        headers: { 'Authorization': `Bearer ${this.accessToken}` }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        return data;
                    }
                    return null;
                } catch (error) {
                    console.error(`Error reading ${filename}:`, error);
                    return null;
                }
            }
            
            async writeFile(filename, data) {
                try {
                    await this.ensureAppFolder();
                    
                    const response = await fetch(`${this.baseUrl}/root:/PersonalOrganizer/${filename}:/content`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${this.accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                    
                    return response.ok;
                } catch (error) {
                    console.error(`Error writing ${filename}:`, error);
                    return false;
                }
            }
            
            async getFileMetadata(filename) {
                try {
                    const response = await fetch(`${this.baseUrl}/root:/PersonalOrganizer/${filename}`, {
                        headers: { 'Authorization': `Bearer ${this.accessToken}` }
                    });
                    
                    if (response.ok) {
                        return await response.json();
                    }
                    return null;
                } catch (error) {
                    console.error(`Error getting metadata for ${filename}:`, error);
                    return null;
                }
            }
        }
        
        // Utility Functions
        const formatDateForDisplay = (dateString) => {
            if (!dateString) return '';
            const date = new Date(dateString);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        };
        
        const parseDisplayDate = (displayDate) => {
            if (!displayDate) return '';
            const [day, month, year] = displayDate.split('/');
            if (!day || !month || !year) return '';
            return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        };
        
        const getCategoryClass = (category) => {
            if (!category) return 'event-other';
            
            const categoryMap = {
                'home': 'event-home',
                'leisure': 'event-leisure',
                'gr-yaris': 'event-gr-yaris',
                'street-triple': 'event-street-triple',
                'birthday': 'event-birthday',
                'other': 'event-other',
                'poubelles-black': 'event-poubelles-black',
                'poubelles-blue': 'event-poubelles-blue',
                'poubelles-green': 'event-poubelles-green',
                'poubelles-blue-bag': 'event-poubelles-blue-bag'
            };
            
            // Check for exact match first
            if (categoryMap[category]) return categoryMap[category];
            
            // Check for partial matches
            for (const [key, value] of Object.entries(categoryMap)) {
                if (category.includes(key)) return value;
            }
            
            return 'event-other';
        };
        
        // Main App Component
        function PersonalOrganizer() {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [account, setAccount] = useState(null);
            const [activeTab, setActiveTab] = useState('tasks');
            const [tasks, setTasks] = useState([]);
            const [events, setEvents] = useState([]);
            const [groceries, setGroceries] = useState([]);
            const [showAddModal, setShowAddModal] = useState(false);
            const [showDetailsModal, setShowDetailsModal] = useState(false);
            const [selectedItem, setSelectedItem] = useState(null);
            const [syncStatus, setSyncStatus] = useState('offline'); // offline, syncing, synced, error
            const [currentDate, setCurrentDate] = useState(new Date());
            const [calendarView, setCalendarView] = useState('month'); // month or year
            const [oneDriveSync, setOneDriveSync] = useState(null);
            const [showConflictModal, setShowConflictModal] = useState(false);
            const [conflictData, setConflictData] = useState(null);
            const [activeFilters, setActiveFilters] = useState({
                tasks: 'all',
                groceries: 'all'
            });
            
            // Form States
            const [lastUsedCategories, setLastUsedCategories] = useState({
                task: 'home',
                event: 'home',
                grocery: ''
            });
            
            // Authentication
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        const accounts = await msalInstance.getAllAccounts();
                        if (accounts.length > 0) {
                            setAccount(accounts[0]);
                            setIsAuthenticated(true);
                            await acquireTokenAndSync();
                        }
                    } catch (error) {
                        console.error('Auth initialization error:', error);
                    }
                };
                initAuth();
            }, []);
            
            const signIn = async () => {
                try {
                    const loginResponse = await msalInstance.loginPopup({
                        scopes: ["Files.ReadWrite", "User.Read"]
                    });
                    setAccount(loginResponse.account);
                    setIsAuthenticated(true);
                    await acquireTokenAndSync();
                } catch (error) {
                    console.error('Login error:', error);
                }
            };
            
            const signOut = () => {
                msalInstance.logoutPopup();
                setIsAuthenticated(false);
                setAccount(null);
                setOneDriveSync(null);
                // Clear local data
                localStorage.clear();
            };
            
            const acquireTokenAndSync = async () => {
                try {
                    const tokenResponse = await msalInstance.acquireTokenSilent({
                        scopes: ["Files.ReadWrite"],
                        account: msalInstance.getAllAccounts()[0]
                    });
                    
                    const sync = new OneDriveSync(tokenResponse.accessToken);
                    setOneDriveSync(sync);
                    await performSync(sync);
                } catch (error) {
                    console.error('Token acquisition error:', error);
                    setSyncStatus('error');
                }
            };
            
            // Data Management
            const loadLocalData = () => {
                const localTasks = JSON.parse(localStorage.getItem('tasks') || '[]');
                const localEvents = JSON.parse(localStorage.getItem('events') || '[]');
                const localGroceries = JSON.parse(localStorage.getItem('groceries') || '[]');
                
                setTasks(localTasks);
                setEvents(localEvents);
                setGroceries(localGroceries);
            };
            
            const saveLocalData = (data) => {
                if (data.tasks !== undefined) {
                    localStorage.setItem('tasks', JSON.stringify(data.tasks));
                    setTasks(data.tasks);
                }
                if (data.events !== undefined) {
                    localStorage.setItem('events', JSON.stringify(data.events));
                    setEvents(data.events);
                }
                if (data.groceries !== undefined) {
                    localStorage.setItem('groceries', JSON.stringify(data.groceries));
                    setGroceries(data.groceries);
                }
                
                // Trigger sync after local save
                if (oneDriveSync) {
                    performSync(oneDriveSync);
                }
            };
            
            const performSync = async (sync) => {
                setSyncStatus('syncing');
                
                try {
                    // Get local timestamps
                    const localTimestamp = localStorage.getItem('lastSync') || '0';
                    
                    // Get remote data and metadata
                    const [remoteTasks, remoteEvents, remoteGroceries] = await Promise.all([
                        sync.readFile('tasks.json'),
                        sync.readFile('events.json'),
                        sync.readFile('groceries.json')
                    ]);
                    
                    const [tasksMetadata, eventsMetadata, groceriesMetadata] = await Promise.all([
                        sync.getFileMetadata('tasks.json'),
                        sync.getFileMetadata('events.json'),
                        sync.getFileMetadata('groceries.json')
                    ]);
                    
                    // Check for conflicts
                    const remoteTimestamp = Math.max(
                        tasksMetadata?.lastModifiedDateTime ? new Date(tasksMetadata.lastModifiedDateTime).getTime() : 0,
                        eventsMetadata?.lastModifiedDateTime ? new Date(eventsMetadata.lastModifiedDateTime).getTime() : 0,
                        groceriesMetadata?.lastModifiedDateTime ? new Date(groceriesMetadata.lastModifiedDateTime).getTime() : 0
                    );
                    
                    if (remoteTimestamp > parseInt(localTimestamp) && remoteTasks) {
                        // Potential conflict - check if local has unsaved changes
                        const localHasChanges = localStorage.getItem('hasUnsyncedChanges') === 'true';
                        
                        if (localHasChanges) {
                            // Show conflict resolution
                            setConflictData({
                                local: { tasks, events, groceries },
                                remote: { 
                                    tasks: remoteTasks || [], 
                                    events: remoteEvents || [], 
                                    groceries: remoteGroceries || [] 
                                }
                            });
                            setShowConflictModal(true);
                            setSyncStatus('error');
                            return;
                        } else {
                            // No local changes, use remote
                            saveLocalData({
                                tasks: remoteTasks || [],
                                events: remoteEvents || [],
                                groceries: remoteGroceries || []
                            });
                        }
                    } else {
                        // Local is newer or same, push to remote
                        await Promise.all([
                            sync.writeFile('tasks.json', tasks),
                            sync.writeFile('events.json', events),
                            sync.writeFile('groceries.json', groceries)
                        ]);
                    }
                    
                    localStorage.setItem('lastSync', Date.now().toString());
                    localStorage.setItem('hasUnsyncedChanges', 'false');
                    setSyncStatus('synced');
                } catch (error) {
                    console.error('Sync error:', error);
                    setSyncStatus('error');
                }
            };
            
            const resolveConflict = (useLocal) => {
                if (useLocal) {
                    // Keep local version and push to remote
                    if (oneDriveSync) {
                        Promise.all([
                            oneDriveSync.writeFile('tasks.json', tasks),
                            oneDriveSync.writeFile('events.json', events),
                            oneDriveSync.writeFile('groceries.json', groceries)
                        ]).then(() => {
                            setSyncStatus('synced');
                            localStorage.setItem('lastSync', Date.now().toString());
                            localStorage.setItem('hasUnsyncedChanges', 'false');
                        });
                    }
                } else {
                    // Use remote version
                    saveLocalData(conflictData.remote);
                    setSyncStatus('synced');
                    localStorage.setItem('lastSync', Date.now().toString());
                    localStorage.setItem('hasUnsyncedChanges', 'false');
                }
                
                setShowConflictModal(false);
                setConflictData(null);
            };
            
            // CRUD Operations
            const addTask = (taskData) => {
                const newTask = {
                    id: Date.now(),
                    ...taskData,
                    completed: false,
                    createdAt: new Date().toISOString()
                };
                
                const updatedTasks = [...tasks, newTask];
                saveLocalData({ tasks: updatedTasks });
                localStorage.setItem('hasUnsyncedChanges', 'true');
                setLastUsedCategories(prev => ({ ...prev, task: taskData.category }));
            };
            
            const addEvent = (eventData) => {
                const newEvent = {
                    id: Date.now(),
                    ...eventData,
                    createdAt: new Date().toISOString()
                };
                
                let updatedEvents = [...events, newEvent];
                
                // Handle recurring events
                if (eventData.isRecurring && eventData.recurrenceMonths) {
                    const baseDate = new Date(eventData.date);
                    for (let i = 1; i <= 70; i++) {
                        const futureDate = new Date(baseDate);
                        futureDate.setMonth(futureDate.getMonth() + (eventData.recurrenceMonths * i));
                        
                        const recurringEvent = {
                            ...newEvent,
                            id: Date.now() + i,
                            date: futureDate.toISOString().split('T')[0],
                            parentEventId: newEvent.id
                        };
                        
                        updatedEvents.push(recurringEvent);
                    }
                }
                
                saveLocalData({ events: updatedEvents });
                localStorage.setItem('hasUnsyncedChanges', 'true');
                setLastUsedCategories(prev => ({ ...prev, event: eventData.category.split('-')[0] }));
            };
            
            const addGrocery = (groceryData) => {
                const newGrocery = {
                    id: Date.now(),
                    ...groceryData,
                    completed: false,
                    createdAt: new Date().toISOString()
                };
                
                const updatedGroceries = [...groceries, newGrocery];
                saveLocalData({ groceries: updatedGroceries });
                localStorage.setItem('hasUnsyncedChanges', 'true');
                setLastUsedCategories(prev => ({ ...prev, grocery: groceryData.category }));
            };
            
            const toggleTask = (taskId) => {
                const updatedTasks = tasks.map(task => 
                    task.id === taskId 
                        ? { 
                            ...task, 
                            completed: !task.completed,
                            completedAt: !task.completed ? new Date().toISOString() : null
                          }
                        : task
                );
                saveLocalData({ tasks: updatedTasks });
                localStorage.setItem('hasUnsyncedChanges', 'true');
            };
            
            const deleteTask = (taskId) => {
                const updatedTasks = tasks.filter(task => task.id !== taskId);
                saveLocalData({ tasks: updatedTasks });
                localStorage.setItem('hasUnsyncedChanges', 'true');
            };
            
            const deleteEvent = (eventId) => {
                const updatedEvents = events.filter(event => event.id !== eventId);
                saveLocalData({ events: updatedEvents });
                localStorage.setItem('hasUnsyncedChanges', 'true');
            };
            
            const toggleGrocery = (groceryId) => {
                const updatedGroceries = groceries.map(item => 
                    item.id === groceryId 
                        ? { ...item, completed: !item.completed }
                        : item
                );
                saveLocalData({ groceries: updatedGroceries });
                localStorage.setItem('hasUnsyncedChanges', 'true');
            };
            
            const deleteGrocery = (groceryId) => {
                const updatedGroceries = groceries.filter(item => item.id !== groceryId);
                saveLocalData({ groceries: updatedGroceries });
                localStorage.setItem('hasUnsyncedChanges', 'true');
            };
            
            const clearCompletedGroceries = () => {
                const updatedGroceries = groceries.filter(item => !item.completed);
                saveLocalData({ groceries: updatedGroceries });
                localStorage.setItem('hasUnsyncedChanges', 'true');
            };
            
            // Load initial data
            useEffect(() => {
                loadLocalData();
            }, []);
            
            // Auto-sync on focus
            useEffect(() => {
                const handleFocus = () => {
                    if (oneDriveSync) {
                        performSync(oneDriveSync);
                    }
                };
                
                window.addEventListener('focus', handleFocus);
                return () => window.removeEventListener('focus', handleFocus);
            }, [oneDriveSync, tasks, events, groceries]);
            
            // Periodic sync every 5 minutes
            useEffect(() => {
                const interval = setInterval(() => {
                    if (oneDriveSync) {
                        performSync(oneDriveSync);
                    }
                }, 5 * 60 * 1000);
                
                return () => clearInterval(interval);
            }, [oneDriveSync, tasks, events, groceries]);
            
            if (!isAuthenticated) {
                return <LoginScreen onSignIn={signIn} />;
            }
            
            return (
                <div className="app-container">
                    <SyncIndicator status={syncStatus} />
                    
                    <NavigationTabs activeTab={activeTab} onTabChange={setActiveTab} />
                    
                    {activeTab === 'tasks' && (
                        <TasksTab 
                            tasks={tasks}
                            onToggleTask={toggleTask}
                            onDeleteTask={deleteTask}
                            activeFilter={activeFilters.tasks}
                            onFilterChange={(filter) => setActiveFilters(prev => ({ ...prev, tasks: filter }))}
                            onTaskClick={(task) => {
                                setSelectedItem(task);
                                setShowDetailsModal(true);
                            }}
                        />
                    )}
                    
                    {activeTab === 'calendar' && (
                        <CalendarTab
                            events={events}
                            tasks={tasks}
                            currentDate={currentDate}
                            onDateChange={setCurrentDate}
                            calendarView={calendarView}
                            onViewChange={setCalendarView}
                            onEventClick={(item) => {
                                setSelectedItem(item);
                                setShowDetailsModal(true);
                            }}
                            onEmptyDateClick={(date) => {
                                setSelectedItem({ date, type: 'event' });
                                setShowAddModal(true);
                            }}
                        />
                    )}
                    
                    {activeTab === 'groceries' && (
                        <GroceriesTab
                            groceries={groceries}
                            onToggleGrocery={toggleGrocery}
                            onDeleteGrocery={deleteGrocery}
                            onClearCompleted={clearCompletedGroceries}
                            activeFilter={activeFilters.groceries}
                            onFilterChange={(filter) => setActiveFilters(prev => ({ ...prev, groceries: filter }))}
                        />
                    )}
                    
                    <button className="fab" onClick={() => setShowAddModal(true)}>
                        <i className="fas fa-plus"></i>
                    </button>
                    
                    {showAddModal && (
                        <AddModal
                            activeTab={activeTab}
                            onClose={() => setShowAddModal(false)}
                            onAddTask={addTask}
                            onAddEvent={addEvent}
                            onAddGrocery={addGrocery}
                            lastUsedCategories={lastUsedCategories}
                            preselectedDate={selectedItem?.date}
                            keepOpen={true}
                        />
                    )}
                    
                    {showDetailsModal && selectedItem && (
                        <DetailsModal
                            item={selectedItem}
                            onClose={() => {
                                setShowDetailsModal(false);
                                setSelectedItem(null);
                            }}
                            onModify={() => {
                                setShowDetailsModal(false);
                                setShowAddModal(true);
                            }}
                            onDelete={() => {
                                if (selectedItem.type === 'task') {
                                    deleteTask(selectedItem.id);
                                } else if (selectedItem.type === 'event') {
                                    deleteEvent(selectedItem.id);
                                }
                                setShowDetailsModal(false);
                                setSelectedItem(null);
                            }}
                        />
                    )}
                    
                    {showConflictModal && conflictData && (
                        <ConflictModal
                            localData={conflictData.local}
                            remoteData={conflictData.remote}
                            onResolve={resolveConflict}
                        />
                    )}
                    
                    <div className="sign-out-wrapper">
                        <button className="btn btn-secondary" onClick={signOut}>
                            <i className="fas fa-sign-out-alt"></i> Sign Out
                        </button>
                    </div>
                </div>
            );
        }
        
        // Component: Login Screen
        function LoginScreen({ onSignIn }) {
            return (
                <div className="app-container" style={{ textAlign: 'center', padding: '60px 30px' }}>
                    <h1 style={{ fontSize: '2.5em', marginBottom: '20px', color: '#2c3e50' }}>
                        Personal Organizer
                    </h1>
                    <p style={{ fontSize: '1.2em', color: '#7f8c8d', marginBottom: '40px' }}>
                        Sign in with your Microsoft account to sync across devices
                    </p>
                    <button className="btn" onClick={onSignIn} style={{ fontSize: '18px', padding: '15px 40px' }}>
                        <i className="fab fa-microsoft"></i> Sign in with Microsoft
                    </button>
                    <p style={{ marginTop: '40px', color: '#95a5a6', fontSize: '14px' }}>
                        Your data will be stored securely in your OneDrive
                    </p>
                </div>
            );
        }
        
        // Component: Sync Indicator
        function SyncIndicator({ status }) {
            return (
                <div className="sync-indicator">
                    <div className={`sync-dot ${status}`}></div>
                    <span style={{ fontSize: '14px', color: '#7f8c8d' }}>
                        {status === 'offline' && 'Offline'}
                        {status === 'syncing' && 'Syncing...'}
                        {status === 'synced' && 'Synced'}
                        {status === 'error' && 'Sync Error'}
                    </span>
                </div>
            );
        }
        
        // Component: Navigation Tabs
        function NavigationTabs({ activeTab, onTabChange }) {
            return (
                <div className="nav-tabs">
                    <button 
                        className={`nav-tab ${activeTab === 'tasks' ? 'active' : ''}`}
                        onClick={() => onTabChange('tasks')}
                    >
                        📋 Tasks
                    </button>
                    <button 
                        className={`nav-tab ${activeTab === 'calendar' ? 'active' : ''}`}
                        onClick={() => onTabChange('calendar')}
                    >
                        📅 Calendar
                    </button>
                    <button 
                        className={`nav-tab ${activeTab === 'groceries' ? 'active' : ''}`}
                        onClick={() => onTabChange('groceries')}
                    >
                        🛒 Groceries
                    </button>
                </div>
            );
        }
        
        // Component: Tasks Tab
        function TasksTab({ tasks, onToggleTask, onDeleteTask, activeFilter, onFilterChange, onTaskClick }) {
            const filteredTasks = activeFilter === 'all' 
                ? tasks 
                : tasks.filter(task => task.category === activeFilter);
            
            const openTasks = filteredTasks.filter(task => !task.completed);
            const completedTasks = filteredTasks.filter(task => task.completed);
            
            const stats = {
                total: tasks.length,
                completed: tasks.filter(t => t.completed).length,
                overdue: tasks.filter(t => !t.completed && t.dueDate && new Date(t.dueDate) < new Date()).length,
                upcoming: tasks.filter(t => {
                    if (!t.dueDate || t.completed) return false;
                    const dueDate = new Date(t.dueDate);
                    const weekFromNow = new Date();
                    weekFromNow.setDate(weekFromNow.getDate() + 7);
                    return dueDate >= new Date() && dueDate <= weekFromNow;
                }).length
            };
            
            return (
                <div>
                    <div className="stats-grid">
                        <div className="stat-card">
                            <div className="stat-number">{stats.total}</div>
                            <div className="stat-label">Total Tasks</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-number">{stats.completed}</div>
                            <div className="stat-label">Completed</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-number">{stats.overdue}</div>
                            <div className="stat-label">Overdue</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-number">{stats.upcoming}</div>
                            <div className="stat-label">Due This Week</div>
                        </div>
                    </div>
                    
                    <div className="category-filters">
                        <div 
                            className={`category-filter ${activeFilter === 'all' ? 'active' : ''}`}
                            onClick={() => onFilterChange('all')}
                        >
                            All Categories
                        </div>
                        <div 
                            className={`category-filter ${activeFilter === 'home' ? 'active' : ''}`}
                            onClick={() => onFilterChange('home')}
                        >
                            🏠 Home
                        </div>
                        <div 
                            className={`category-filter ${activeFilter === 'leisure' ? 'active' : ''}`}
                            onClick={() => onFilterChange('leisure')}
                        >
                            🎯 Leisure
                        </div>
                        <div 
                            className={`category-filter ${activeFilter === 'gr-yaris' ? 'active' : ''}`}
                            onClick={() => onFilterChange('gr-yaris')}
                        >
                            🏎️ GR Yaris
                        </div>
                        <div 
                            className={`category-filter ${activeFilter === 'street-triple' ? 'active' : ''}`}
                            onClick={() => onFilterChange('street-triple')}
                        >
                            🏍️ Street Triple
                        </div>
                    </div>
                    
                    <div className="task-section">
                        <div className="section-header">
                            <h2 className="section-title">Open Tasks ({openTasks.length})</h2>
                        </div>
                        {openTasks.length === 0 ? (
                            <div className="empty-state">
                                <h3>No open tasks</h3>
                                <p>All caught up!</p>
                            </div>
                        ) : (
                            openTasks.map(task => (
                                <TaskCard 
                                    key={task.id} 
                                    task={task} 
                                    onToggle={() => onToggleTask(task.id)}
                                    onDelete={() => onDeleteTask(task.id)}
                                    onClick={() => onTaskClick({ ...task, type: 'task' })}
                                />
                            ))
                        )}
                    </div>
                    
                    <div className="task-section">
                        <div className="section-header">
                            <h2 className="section-title">Completed Tasks ({completedTasks.length})</h2>
                        </div>
                        {completedTasks.length === 0 ? (
                            <div className="empty-state">
                                <h3>No completed tasks</h3>
                                <p>Complete some tasks to see them here!</p>
                            </div>
                        ) : (
                            completedTasks.map(task => (
                                <TaskCard 
                                    key={task.id} 
                                    task={task} 
                                    onToggle={() => onToggleTask(task.id)}
                                    onDelete={() => onDeleteTask(task.id)}
                                    onClick={() => onTaskClick({ ...task, type: 'task' })}
                                />
                            ))
                        )}
                    </div>
                </div>
            );
        }
        
        // Component: Task Card
        function TaskCard({ task, onToggle, onDelete, onClick }) {
            const isOverdue = task.dueDate && new Date(task.dueDate) < new Date() && !task.completed;
            
            const getCategoryIcon = (category) => {
                const icons = {
                    'home': '🏠',
                    'leisure': '🎯',
                    'gr-yaris': '🏎️',
                    'street-triple': '🏍️'
                };
                return icons[category] || '📋';
            };
            
            return (
                <div className={`task-card ${task.completed ? 'completed' : ''} ${isOverdue ? 'overdue' : ''}`}>
                    <div className="task-header" onClick={onClick} style={{ cursor: 'pointer' }}>
                        <h3 className="task-title">{task.title}</h3>
                        <div className="task-badges">
                            <span className="badge" style={{ background: '#e3f2fd', color: '#1976d2' }}>
                                {getCategoryIcon(task.category)} {task.category.replace('-', ' ')}
                            </span>
                            <span className={`badge priority-${task.priority}`}>
                                {task.priority}
                            </span>
                        </div>
                    </div>
                    
                    {task.description && (
                        <p style={{ marginBottom: '10px', color: '#7f8c8d' }}>{task.description}</p>
                    )}
                    
                    <div className="task-meta">
                        {task.dueDate && <span>Due: {formatDateForDisplay(task.dueDate)}</span>}
                        <span>Created: {formatDateForDisplay(task.createdAt)}</span>
                    </div>
                    
                    <div className="task-actions">
                        <button className="btn btn-sm btn-success" onClick={(e) => { e.stopPropagation(); onToggle(); }}>
                            {task.completed ? '↩️ Undo' : '✓ Complete'}
                        </button>
                        <button className="btn btn-sm btn-danger" onClick={(e) => { e.stopPropagation(); onDelete(); }}>
                            🗑️ Delete
                        </button>
                    </div>
                </div>
            );
        }
        
        // Component: Calendar Tab
        function CalendarTab({ events, tasks, currentDate, onDateChange, calendarView, onViewChange, onEventClick, onEmptyDateClick }) {
            const changeMonth = (direction) => {
                const newDate = new Date(currentDate);
                newDate.setMonth(newDate.getMonth() + direction);
                onDateChange(newDate);
            };
            
            const goToToday = () => {
                onDateChange(new Date());
            };
            
            if (calendarView === 'year') {
                return (
                    <div className="calendar-container">
                        <div className="calendar-header">
                            <div className="calendar-nav">
                                <button onClick={() => {
                                    const newDate = new Date(currentDate);
                                    newDate.setFullYear(newDate.getFullYear() - 1);
                                    onDateChange(newDate);
                                }}>‹</button>
                                <button onClick={() => {
                                    const newDate = new Date(currentDate);
                                    newDate.setFullYear(newDate.getFullYear() + 1);
                                    onDateChange(newDate);
                                }}>›</button>
                            </div>
                            <h2 className="calendar-title">{currentDate.getFullYear()}</h2>
                            <div style={{ display: 'flex', gap: '10px' }}>
                                <button className="btn btn-sm" onClick={goToToday}>Today</button>
                                <button className="btn btn-sm" onClick={() => onViewChange('month')}>
                                    <i className="fas fa-calendar-day"></i>
                                </button>
                            </div>
                        </div>
                        <YearView 
                            year={currentDate.getFullYear()} 
                            events={events} 
                            tasks={tasks}
                            onMonthClick={(month) => {
                                const newDate = new Date(currentDate);
                                newDate.setMonth(month);
                                onDateChange(newDate);
                                onViewChange('month');
                            }}
                        />
                    </div>
                );
            }
            
            return (
                <div className="calendar-container">
                    <div className="calendar-header">
                        <div className="calendar-nav">
                            <button onClick={() => changeMonth(-1)}>‹</button>
                            <button onClick={() => changeMonth(1)}>›</button>
                        </div>
                        <h2 className="calendar-title">
                            {currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                        </h2>
                        <div style={{ display: 'flex', gap: '10px' }}>
                            <button className="btn btn-sm" onClick={goToToday}>Today</button>
                            <button className="btn btn-sm" onClick={() => onViewChange('year')}>
                                <i className="fas fa-calendar"></i>
                            </button>
                        </div>
                    </div>
                    <MonthView 
                        currentDate={currentDate} 
                        events={events} 
                        tasks={tasks}
                        onEventClick={onEventClick}
                        onEmptyDateClick={onEmptyDateClick}
                    />
                </div>
            );
        }
        
        // Component: Month View
        function MonthView({ currentDate, events, tasks, onEventClick, onEmptyDateClick }) {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            const adjustedStartDay = startingDayOfWeek === 0 ? 6 : startingDayOfWeek - 1;
            
            const days = [];
            const dayHeaders = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            
            // Previous month's trailing days
            const prevMonth = new Date(year, month - 1, 0);
            const prevMonthDays = prevMonth.getDate();
            for (let i = adjustedStartDay - 1; i >= 0; i--) {
                days.push({
                    day: prevMonthDays - i,
                    isOtherMonth: true,
                    date: new Date(year, month - 1, prevMonthDays - i)
                });
            }
            
            // Current month days
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                days.push({
                    day,
                    isOtherMonth: false,
                    isToday: date.toDateString() === today.toDateString(),
                    date
                });
            }
            
            // Next month's leading days
            const remainingCells = 42 - days.length;
            for (let day = 1; day <= remainingCells; day++) {
                days.push({
                    day,
                    isOtherMonth: true,
                    date: new Date(year, month + 1, day)
                });
            }
            
            return (
                <div className="calendar-grid">
                    {dayHeaders.map(header => (
                        <div key={header} className="calendar-day-header">{header}</div>
                    ))}
                    {days.map((dayInfo, index) => {
                        const dateStr = dayInfo.date.toISOString().split('T')[0];
                        const dayEvents = events.filter(e => e.date === dateStr);
                        const dayTasks = tasks.filter(t => t.dueDate === dateStr);
                        
                        return (
                            <div 
                                key={index} 
                                className={`calendar-day ${dayInfo.isOtherMonth ? 'other-month' : ''} ${dayInfo.isToday ? 'today' : ''}`}
                                onDoubleClick={() => !dayInfo.isOtherMonth && onEmptyDateClick(dateStr)}
                            >
                                <div className="calendar-day-number">{dayInfo.day}</div>
                                {dayEvents.map(event => (
                                    <div 
                                        key={event.id} 
                                        className={`calendar-event ${getCategoryClass(event.category)}`}
                                        onClick={() => onEventClick({ ...event, type: 'event' })}
                                    >
                                        {event.time && `${event.time} `}{event.title}
                                    </div>
                                ))}
                                {dayTasks.map(task => (
                                    <div 
                                        key={task.id} 
                                        className="calendar-event event-task"
                                        onClick={() => onEventClick({ ...task, type: 'task' })}
                                    >
                                        {task.completed ? '✓' : '📋'} {task.title}
                                    </div>
                                ))}
                            </div>
                        );
                    })}
                </div>
            );
        }
        
        // Component: Year View
        function YearView({ year, events, tasks, onMonthClick }) {
            const months = [];
            
            for (let month = 0; month < 12; month++) {
                const monthName = new Date(year, month).toLocaleDateString('en-US', { month: 'long' });
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startingDayOfWeek = firstDay.getDay();
                const adjustedStartDay = startingDayOfWeek === 0 ? 6 : startingDayOfWeek - 1;
                
                const days = [];
                
                // Fill with empty cells for alignment
                for (let i = 0; i < adjustedStartDay; i++) {
                    days.push(null);
                }
                
                // Add month days
                const today = new Date();
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const dateStr = date.toISOString().split('T')[0];
                    const hasEvents = events.some(e => e.date === dateStr) || tasks.some(t => t.dueDate === dateStr);
                    const isToday = date.toDateString() === today.toDateString();
                    
                    days.push({ day, hasEvents, isToday });
                }
                
                months.push({ month, monthName, days });
            }
            
            return (
                <div className="year-view">
                    {months.map(({ month, monthName, days }) => (
                        <div key={month} className="month-mini" onClick={() => onMonthClick(month)}>
                            <div className="month-mini-header">{monthName}</div>
                            <div className="month-mini-grid">
                                {['M', 'T', 'W', 'T', 'F', 'S', 'S'].map((d, i) => (
                                    <div key={i} style={{ fontSize: '10px', textAlign: 'center', color: '#95a5a6' }}>{d}</div>
                                ))}
                                {days.map((day, index) => (
                                    <div 
                                        key={index} 
                                        className={`month-mini-day ${day?.hasEvents ? 'has-events' : ''} ${day?.isToday ? 'today' : ''}`}
                                    >
                                        {day?.day || ''}
                                    </div>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
            );
        }
        
        // Component: Groceries Tab
        function GroceriesTab({ groceries, onToggleGrocery, onDeleteGrocery, onClearCompleted, activeFilter, onFilterChange }) {
            const filteredGroceries = activeFilter === 'all' 
                ? groceries 
                : groceries.filter(item => (item.category || '') === activeFilter);
            
            const hasCompletedItems = groceries.some(item => item.completed);
            
            const getCategoryIcon = (category) => {
                const icons = {
                    'dairy': '🥛',
                    'meat': '🥩',
                    'vegetables': '🥕',
                    'fruits': '🍎',
                    'grains': '🍞',
                    'snacks': '🍿',
                    'beverages': '🥤',
                    'cleaning': '🧽',
                    'personal-care': '🧴',
                    'other': '📦'
                };
                return icons[category] || '🛒';
            };
            
            return (
                <div>
                    <div className="category-filters">
                        <div 
                            className={`category-filter ${activeFilter === 'all' ? 'active' : ''}`}
                            onClick={() => onFilterChange('all')}
                        >
                            All Items
                        </div>
                        <div 
                            className={`category-filter ${activeFilter === '' ? 'active' : ''}`}
                            onClick={() => onFilterChange('')}
                        >
                            🛒 Uncategorized
                        </div>
                        <div 
                            className={`category-filter ${activeFilter === 'dairy' ? 'active' : ''}`}
                            onClick={() => onFilterChange('dairy')}
                        >
                            🥛 Dairy
                        </div>
                        <div 
                            className={`category-filter ${activeFilter === 'meat' ? 'active' : ''}`}
                            onClick={() => onFilterChange('meat')}
                        >
                            🥩 Meat
                        </div>
                        <div 
                            className={`category-filter ${activeFilter === 'vegetables' ? 'active' : ''}`}
                            onClick={() => onFilterChange('vegetables')}
                        >
                            🥕 Vegetables
                        </div>
                        <div 
                            className={`category-filter ${activeFilter === 'fruits' ? 'active' : ''}`}
                            onClick={() => onFilterChange('fruits')}
                        >
                            🍎 Fruits
                        </div>
                        <div 
                            className={`category-filter ${activeFilter === 'grains' ? 'active' : ''}`}
                            onClick={() => onFilterChange('grains')}
                        >
                            🍞 Grains
                        </div>
                        <div 
                            className={`category-filter ${activeFilter === 'snacks' ? 'active' : ''}`}
                            onClick={() => onFilterChange('snacks')}
                        >
                            🍿 Snacks
                        </div>
                        <div 
                            className={`category-filter ${activeFilter === 'beverages' ? 'active' : ''}`}
                            onClick={() => onFilterChange('beverages')}
                        >
                            🥤 Beverages
                        </div>
                        <div 
                            className={`category-filter ${activeFilter === 'cleaning' ? 'active' : ''}`}
                            onClick={() => onFilterChange('cleaning')}
                        >
                            🧽 Cleaning
                        </div>
                        <div 
                            className={`category-filter ${activeFilter === 'personal-care' ? 'active' : ''}`}
                            onClick={() => onFilterChange('personal-care')}
                        >
                            🧴 Personal Care
                        </div>
                        <div 
                            className={`category-filter ${activeFilter === 'other' ? 'active' : ''}`}
                            onClick={() => onFilterChange('other')}
                        >
                            📦 Other
                        </div>
                    </div>
                    
                    {filteredGroceries.length === 0 ? (
                        <div className="empty-state">
                            <h3>No grocery items</h3>
                            <p>Add your first item to start your shopping list!</p>
                        </div>
                    ) : (
                        <>
                            {filteredGroceries.map(item => (
                                <div key={item.id} className={`grocery-item ${item.completed ? 'completed' : ''}`}>
                                    <input 
                                        type="checkbox" 
                                        className="grocery-checkbox"
                                        checked={item.completed}
                                        onChange={() => onToggleGrocery(item.id)}
                                    />
                                    <div className="grocery-content">
                                        <span className="grocery-name">{item.item}</span>
                                        <div style={{ display: 'flex', gap: '10px', alignItems: 'center' }}>
                                            {item.category && (
                                                <span className="badge" style={{ background: '#f8f9fa', color: '#6c757d' }}>
                                                    {getCategoryIcon(item.category)} {item.category.replace('-', ' ')}
                                                </span>
                                            )}
                                            <button 
                                                className="btn btn-sm btn-danger"
                                                onClick={() => onDeleteGrocery(item.id)}
                                            >
                                                ×
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            ))}
                            
                            {hasCompletedItems && (
                                <div style={{ textAlign: 'center', marginTop: '30px' }}>
                                    <button className="btn btn-danger" onClick={onClearCompleted}>
                                        🗑️ Clear Completed Items
                                    </button>
                                </div>
                            )}
                        </>
                    )}
                </div>
            );
        }
        
        // Component: Add Modal
        function AddModal({ activeTab, onClose, onAddTask, onAddEvent, onAddGrocery, lastUsedCategories, preselectedDate, keepOpen }) {
            const [formType, setFormType] = useState(
                activeTab === 'tasks' ? 'task' : 
                activeTab === 'calendar' ? 'event' : 
                'grocery'
            );
            
            const [formData, setFormData] = useState({
                // Task fields
                title: '',
                description: '',
                category: lastUsedCategories[formType] || 'home',
                dueDate: '',
                priority: 'medium',
                
                // Event fields
                date: preselectedDate || '',
                time: '',
                hour: '',
                minute: '00',
                mainCategory: lastUsedCategories.event || 'home',
                subcategory: '',
                isRecurring: false,
                recurrenceMonths: 12,
                
                // Event additional data
                tyreBrand: '',
                tyreModel: '',
                tyreMileage: '',
                brakeBrand: '',
                brakeModel: '',
                brakeMileage: '',
                maintenanceMileage: '',
                
                // Grocery fields
                item: '',
                groceryCategory: lastUsedCategories.grocery || ''
            });
            
            const [showSubcategory, setShowSubcategory] = useState(false);
            const [subcategoryOptions, setSubcategoryOptions] = useState([]);
            const [showAdditionalFields, setShowAdditionalFields] = useState({
                maintenance: false,
                tyres: false,
                brakePads: false,
                vignette: false
            });
            
            const handleMainCategoryChange = (category) => {
                setFormData(prev => ({ ...prev, mainCategory: category, subcategory: '' }));
                
                if (category === 'poubelles') {
                    setShowSubcategory(true);
                    setSubcategoryOptions([
                        { value: 'black', label: '🗑️ General Waste (Black)' },
                        { value: 'blue', label: '📄 Paper/Cardboard (Blue)' },
                        { value: 'green', label: '🍶 Glass (Green)' },
                        { value: 'blue-bag', label: '💛 PMC (Blue Bag)' }
                    ]);
                } else if (category === 'gr-yaris' || category === 'street-triple') {
                    setShowSubcategory(true);
                    setSubcategoryOptions([
                        { value: 'controle-technique', label: '🔧 Contrôle Technique' },
                        { value: 'vignette', label: '🏷️ Vignette' },
                        { value: 'assurance', label: '🛡️ Assurance' },
                        { value: 'entretien', label: '⚙️ Entretien' },
                        { value: 'tyres', label: '🛞 New Tyres' },
                        { value: 'brake-pads', label: '🔧 New Brake Pads' },
                        { value: 'other', label: '📦 Other' }
                    ]);
                } else {
                    setShowSubcategory(false;
                    setSubcategoryOptions([]);
                }
                
                // Reset additional fields
                setShowAdditionalFields({
                    maintenance: false,
                    tyres: false,
                    brakePads: false,
                    vignette: false
                });
            };
            
            const handleSubcategoryChange = (subcategory) => {
                setFormData(prev => ({ ...prev, subcategory }));
                
                // Auto-generate title
                const mainCategoryNames = {
                    'gr-yaris': 'GR Yaris',
                    'street-triple': 'Street Triple',
                    'poubelles': 'Poubelles'
                };
                
                const subcategoryNames = {
                    'controle-technique': 'Contrôle Technique',
                    'vignette': 'Vignette',
                    'assurance': 'Assurance',
                    'entretien': 'Entretien',
                    'tyres': 'New Tyres',
                    'brake-pads': 'New Brake Pads',
                    'black': 'General Waste',
                    'blue': 'Paper/Cardboard',
                    'green': 'Glass',
                    'blue-bag': 'PMC',
                    'other': 'Other'
                };
                
                if (subcategory && subcategory !== 'none') {
                    const title = `${mainCategoryNames[formData.mainCategory]} - ${subcategoryNames[subcategory]}`;
                    setFormData(prev => ({ ...prev, title }));
                    
                    // Show additional fields based on subcategory
                    const newFieldsState = {
                        maintenance: ['controle-technique', 'entretien'].includes(subcategory),
                        tyres: subcategory === 'tyres',
                        brakePads: subcategory === 'brake-pads',
                        vignette: subcategory === 'vignette'
                    };
                    setShowAdditionalFields(newFieldsState);
                    
                    // Set default recurrence
                    const recurringCategories = ['controle-technique', 'vignette', 'assurance', 'entretien'];
                    setFormData(prev => ({ 
                        ...prev, 
                        isRecurring: recurringCategories.includes(subcategory),
                        recurrenceMonths: subcategory === 'vignette' ? 12 : 12
                    }));
                }
            };
            
            const handleSubmit = (e) => {
                e.preventDefault();
                
                if (formType === 'task') {
                    onAddTask({
                        title: formData.title,
                        description: formData.description,
                        category: formData.category,
                        dueDate: parseDisplayDate(formData.dueDate),
                        priority: formData.priority
                    });
                } else if (formType === 'event') {
                    const eventData = {
                        title: formData.title,
                        description: formData.description,
                        date: parseDisplayDate(formData.date),
                        time: formData.hour ? `${formData.hour}:${formData.minute}` : '',
                        category: formData.subcategory ? `${formData.mainCategory}-${formData.subcategory}` : formData.mainCategory,
                        mainCategory: formData.mainCategory,
                        isRecurring: formData.isRecurring,
                        recurrenceMonths: formData.recurrenceMonths
                    };
                    
                    // Add additional data if applicable
                    if (showAdditionalFields.tyres) {
                        eventData.additionalData = {
                            brand: formData.tyreBrand,
                            model: formData.tyreModel,
                            mileage: formData.tyreMileage
                        };
                    } else if (showAdditionalFields.brakePads) {
                        eventData.additionalData = {
                            brand: formData.brakeBrand,
                            model: formData.brakeModel,
                            mileage: formData.brakeMileage
                        };
                    } else if (showAdditionalFields.maintenance) {
                        eventData.additionalData = {
                            mileage: formData.maintenanceMileage
                        };
                    }
                    
                    onAddEvent(eventData);
                } else if (formType === 'grocery') {
                    onAddGrocery({
                        item: formData.item,
                        category: formData.groceryCategory
                    });
                }
                
                if (keepOpen) {
                    // Reset form but keep categories
                    setFormData(prev => ({
                        title: '',
                        description: '',
                        category: prev.category,
                        dueDate: '',
                        priority: 'medium',
                        date: '',
                        time: '',
                        hour: '',
                        minute: '00',
                        mainCategory: prev.mainCategory,
                        subcategory: '',
                        isRecurring: false,
                        recurrenceMonths: 12,
                        tyreBrand: '',
                        tyreModel: '',
                        tyreMileage: '',
                        brakeBrand: '',
                        brakeModel: '',
                        brakeMileage: '',
                        maintenanceMileage: '',
                        item: '',
                        groceryCategory: prev.groceryCategory
                    }));
                    
                    // Reset subcategory display
                    if (!['poubelles', 'gr-yaris', 'street-triple'].includes(formData.mainCategory)) {
                        setShowSubcategory(false);
                    }
                } else {
                    onClose();
                }
            };
            
            const renderDatePicker = (value, onChange, placeholder = "DD/MM/YYYY") => {
                return (
                    <div className="date-input-wrapper">
                        <input
                            type="text"
                            value={value}
                            onChange={(e) => {
                                const input = e.target.value;
                                // Allow typing with automatic formatting
                                if (input.length === 2 || input.length === 5) {
                                    onChange(input + '/');
                                } else if (input.length <= 10) {
                                    onChange(input);
                                }
                            }}
                            onFocus={(e) => {
                                // Show native date picker on focus
                                const hiddenInput = e.target.nextSibling;
                                if (hiddenInput) hiddenInput.showPicker();
                            }}
                            placeholder={placeholder}
                            pattern="\d{2}/\d{2}/\d{4}"
                        />
                        <input
                            type="date"
                            style={{ position: 'absolute', opacity: 0, pointerEvents: 'none' }}
                            onChange={(e) => {
                                if (e.target.value) {
                                    onChange(formatDateForDisplay(e.target.value));
                                }
                            }}
                            value={value ? parseDisplayDate(value) : ''}
                        />
                    </div>
                );
            };
            
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-title">
                                {formType === 'task' && '📋 Add Task'}
                                {formType === 'event' && '📅 Add Event'}
                                {formType === 'grocery' && '🛒 Add Grocery Item'}
                            </h2>
                            <button className="modal-close" onClick={onClose}>×</button>
                        </div>
                        
                        <div className="modal-body">
                            <div className="form-row-3" style={{ marginBottom: '20px' }}>
                                <button 
                                    type="button"
                                    className={`btn btn-sm ${formType === 'task' ? '' : 'btn-secondary'}`}
                                    onClick={() => setFormType('task')}
                                >
                                    Task
                                </button>
                                <button 
                                    type="button"
                                    className={`btn btn-sm ${formType === 'event' ? '' : 'btn-secondary'}`}
                                    onClick={() => setFormType('event')}
                                >
                                    Event
                                </button>
                                <button 
                                    type="button"
                                    className={`btn btn-sm ${formType === 'grocery' ? '' : 'btn-secondary'}`}
                                    onClick={() => setFormType('grocery')}
                                >
                                    Grocery
                                </button>
                            </div>
                            
                            <form onSubmit={handleSubmit}>
                                {formType === 'task' && (
                                    <>
                                        <div className="form-group">
                                            <label>Title</label>
                                            <input 
                                                type="text" 
                                                value={formData.title}
                                                onChange={(e) => setFormData(prev => ({ ...prev, title: e.target.value }))}
                                                required
                                                autoFocus
                                            />
                                        </div>
                                        
                                        <div className="form-group">
                                            <label>Description (optional)</label>
                                            <textarea 
                                                rows="3"
                                                value={formData.description}
                                                onChange={(e) => setFormData(prev => ({ ...prev, description: e.target.value }))}
                                            />
                                        </div>
                                        
                                        <div className="form-group">
                                            <label>Category</label>
                                            <select 
                                                value={formData.category}
                                                onChange={(e) => setFormData(prev => ({ ...prev, category: e.target.value }))}
                                            >
                                                <option value="home">🏠 Home</option>
                                                <option value="leisure">🎯 Leisure</option>
                                                <option value="gr-yaris">🏎️ GR Yaris</option>
                                                <option value="street-triple">🏍️ Street Triple</option>
                                            </select>
                                        </div>
                                        
                                        <div className="form-row">
                                            <div className="form-group">
                                                <label>Due Date</label>
                                                {renderDatePicker(
                                                    formData.dueDate,
                                                    (value) => setFormData(prev => ({ ...prev, dueDate: value }))
                                                )}
                                            </div>
                                            <div className="form-group">
                                                <label>Priority</label>
                                                <select 
                                                    value={formData.priority}
                                                    onChange={(e) => setFormData(prev => ({ ...prev, priority: e.target.value }))}
                                                >
                                                    <option value="low">Low</option>
                                                    <option value="medium">Medium</option>
                                                    <option value="high">High</option>
                                                </select>
                                            </div>
                                        </div>
                                    </>
                                )}
                                
                                {formType === 'event' && (
                                    <>
                                        <div className="form-group">
                                            <label>Title</label>
                                            <input 
                                                type="text" 
                                                value={formData.title}
                                                onChange={(e) => setFormData(prev => ({ ...prev, title: e.target.value }))}
                                                required
                                                autoFocus
                                            />
                                        </div>
                                        
                                        <div className="form-group">
                                            <label>Description (optional)</label>
                                            <textarea 
                                                rows="2"
                                                value={formData.description}
                                                onChange={(e) => setFormData(prev => ({ ...prev, description: e.target.value }))}
                                            />
                                        </div>
                                        
                                        <div className="form-row-3">
                                            <div className="form-group">
                                                <label>Date</label>
                                                {renderDatePicker(
                                                    formData.date,
                                                    (value) => setFormData(prev => ({ ...prev, date: value })),
                                                    "DD/MM/YYYY"
                                                )}
                                            </div>
                                            <div className="form-group">
                                                <label>Hour</label>
                                                <select 
                                                    value={formData.hour}
                                                    onChange={(e) => setFormData(prev => ({ ...prev, hour: e.target.value }))}
                                                >
                                                    <option value="">No time</option>
                                                    {[...Array(24)].map((_, i) => (
                                                        <option key={i} value={i.toString().padStart(2, '0')}>
                                                            {i.toString().padStart(2, '0')}
                                                        </option>
                                                    ))}
                                                </select
